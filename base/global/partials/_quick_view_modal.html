<div id="quick-view-modal" style="display: none;">
    <div class="modal-content">
        {% csrf_token %}
        
        <span class="close-btn" id="close-modal">&times;</span>
        
        <div class="quick-view-layout">
            <div class="qv-image-area">
                <img id="qv-image" src="" alt="Imagem do Produto">
            </div>
            
            <div class="qv-details-area">
                <h2 id="qv-name" class="qv-title">Nome do Produto</h2>
                <p class="qv-price-text">
                    <span id="qv-price" class="price" style="font-size: 1.8rem;">R$ 0,00</span>
                </p>

                <p id="qv-description" class="qv-description">Descrição do produto.</p>

                <div class="qv-options">
                    <h4 class="qv-option-title">Tamanho</h4>
                    <div id="qv-size-options" class="qv-buttons-group"></div>
                </div>

                <div class="qv-options">
                    <h4 class="qv-option-title">Cor</h4>
                    <div id="qv-color-options" class="qv-buttons-group"></div>
                </div>

                <div class="qv-actions">
                    <div class="qv-quantity">
                        <label for="qv-qty">Qtde:</label>
                        <input type="number" id="qv-qty" value="1" min="1" max="10" style="width: 60px; padding: 5px; border: 2px solid var(--primary-color);">
                    </div>
                    
                    <button id="add-to-cart-btn" class="nav-cta qv-add-to-cart" style="background-color: var(--accent-color); color: var(--secondary-color); border-color: var(--accent-color); cursor: pointer;">
                        ADICIONAR AO CARRINHO
                    </button>
                    
                    <a id="qv-view-full-page" href="#" class="qv-full-details-link">
                        Ver Página Completa →
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('quick-view-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const triggers = document.querySelectorAll('.quick-view-trigger'); 

    function openModal(triggerElement) {
        const id = triggerElement.getAttribute('data-product-id');
        const name = triggerElement.getAttribute('data-name');
        const priceStr = triggerElement.getAttribute('data-price'); 
        const description = triggerElement.getAttribute('data-description');
        const img = triggerElement.getAttribute('data-image');
        
        // NOVO: Pega a URL da página de detalhes
        const fullPageUrl = triggerElement.getAttribute('data-url');
        
        const sizes = triggerElement.getAttribute('data-sizes').split(',');
        const colors = triggerElement.getAttribute('data-colors').split(',');

        document.querySelectorAll('.qv-option-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('qv-qty').value = 1;

        document.getElementById('qv-image').src = img;
        document.getElementById('qv-name').textContent = name;
        document.getElementById('qv-price').textContent = `R$ ${priceStr}`;
        document.getElementById('qv-description').textContent = description || "Sem descrição disponível.";
        
        document.getElementById('add-to-cart-btn').setAttribute('data-product-id', id);

        // Atualiza o link de Ver Página Completa
        const linkBtn = document.getElementById('qv-view-full-page');
        if (linkBtn) linkBtn.href = fullPageUrl;
        
        const sizeOptionsEl = document.getElementById('qv-size-options');
        sizeOptionsEl.innerHTML = '';
        sizes.forEach(size => {
            const btn = document.createElement('button');
            btn.textContent = size;
            btn.classList.add('qv-option-btn');
            sizeOptionsEl.appendChild(btn);
        });

        const colorOptionsEl = document.getElementById('qv-color-options');
        colorOptionsEl.innerHTML = '';
        colors.forEach(color => {
            const btn = document.createElement('button');
            btn.textContent = color;
            btn.classList.add('qv-option-btn');
            colorOptionsEl.appendChild(btn);
        });
        
        if(sizeOptionsEl.firstChild) sizeOptionsEl.firstChild.classList.add('selected');
        if(colorOptionsEl.firstChild) colorOptionsEl.firstChild.classList.add('selected');

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; 
    }

    function closeQuickView() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; 
    }

    triggers.forEach(card => {
        card.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
                openModal(card); 
            }
        });
    });

    closeModalBtn.addEventListener('click', closeQuickView);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeQuickView();
        }
    });

    document.querySelectorAll('.qv-buttons-group').forEach(group => {
        group.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                group.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });
    });

    // LÓGICA DO CARRINHO (AJUSTADA)
    document.getElementById('add-to-cart-btn').addEventListener('click', (e) => {
        e.preventDefault();

        const productId = e.target.getAttribute('data-product-id');
        const selectedSize = document.querySelector('#qv-size-options .selected')?.textContent;
        const selectedColor = document.querySelector('#qv-color-options .selected')?.textContent;
        const quantity = document.getElementById('qv-qty').value;

        if (!selectedSize || !selectedColor) {
            alert("Por favor, selecione o tamanho e a cor.");
            return;
        }

        const data = {
            id: productId,
            size: selectedSize,
            color: selectedColor,
            quantity: quantity
        };

        fetch("{% url 'add_to_cart' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.cookie.replace(/(?:^|.*;\s*)csrftoken\s*=\s*([^;]*).*$|^.*$/, "$1")
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) throw new Error(response.status);
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                window.location.href = "{% url 'view_cart' %}"; 
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert("Erro ao adicionar ao carrinho. Tente novamente.");
        });
    });
</script>